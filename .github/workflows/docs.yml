name: Docs

on:
  push: {}
  pull_request: {}

jobs:
  docs-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up uv
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.10'

      - name: Set up Node (for Redoc CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install project deps (only backend)
        run: uv sync --only-group backend

      - name: Generate backend API docs
        run: make api-docs

      - name: Ensure API docs are committed
        run: |
          git diff --exit-code -- docs/docs/api.html || (
            echo "::error::API docs are out of date. Run 'make api-docs' and commit docs/docs/api.html." && exit 1
          )

      - name: Build docs site (MkDocs)
        run: make docs-build

      - name: Upload docs site (PR preview)
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: site
